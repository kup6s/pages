suite: syncer deployment tests
templates:
  - templates/deployment-syncer.yaml
set:
  # allowedHosts is required for all tests
  syncer.allowedHosts:
    - github.com
    - gitlab.com
tests:
  - it: should render with default values
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: spec.replicas
          value: 1
      - equal:
          path: spec.template.spec.containers[0].image
          value: ghcr.io/kup6s/pages-syncer:0.1.0

  - it: should mount PVC
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: sites
            mountPath: /sites

  - it: should set sync interval argument
    set:
      syncer.syncInterval: "10m"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: --sync-interval=10m

  - it: should use custom sites root
    set:
      syncer.sitesRoot: /data/sites
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: --sites-root=/data/sites
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: sites
            mountPath: /data/sites

  - it: should apply security context
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsNonRoot
          value: true
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsUser
          value: 1000

  - it: should include component label
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/component"]
          value: syncer

  - it: should set allowed-hosts argument
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: --allowed-hosts=github.com,gitlab.com

  - it: should set custom allowed-hosts
    set:
      syncer.allowedHosts:
        - forgejo.example.com
        - "*.gitlab.internal"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: --allowed-hosts=forgejo.example.com,*.gitlab.internal
