suite: nginx deployment tests
templates:
  - templates/deployment-nginx.yaml
tests:
  - it: should render with default values
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: spec.replicas
          value: 2

  - it: should use default nginx image
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: docker.io/library/nginx:1.27-alpine

  - it: should mount PVC as read-only
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: sites
            mountPath: /sites
            readOnly: true

  - it: should mount nginx config
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: nginx-config
            mountPath: /etc/nginx/conf.d

  - it: should have pod anti-affinity by default
    asserts:
      - isNotEmpty:
          path: spec.template.spec.affinity.podAntiAffinity

  - it: should have liveness probe
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.path
          value: /health
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.port
          value: 80

  - it: should have readiness probe
    asserts:
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.path
          value: /health

  - it: should set custom replicas
    set:
      nginx.replicas: 3
    asserts:
      - equal:
          path: spec.replicas
          value: 3

  - it: should include component label
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/component"]
          value: nginx
