suite: RBAC tests
templates:
  - templates/serviceaccount-operator.yaml
  - templates/serviceaccount-syncer.yaml
  - templates/clusterrole-operator.yaml
  - templates/clusterrole-syncer.yaml
  - templates/clusterrolebinding-operator.yaml
  - templates/clusterrolebinding-syncer.yaml
  - templates/role-operator.yaml
  - templates/rolebinding-operator.yaml
tests:
  - it: should create operator serviceaccount
    template: templates/serviceaccount-operator.yaml
    asserts:
      - isKind:
          of: ServiceAccount
      - matchRegex:
          path: metadata.name
          pattern: -operator$

  - it: should create syncer serviceaccount
    template: templates/serviceaccount-syncer.yaml
    asserts:
      - isKind:
          of: ServiceAccount
      - matchRegex:
          path: metadata.name
          pattern: -syncer$

  - it: should create operator clusterrole with correct API group
    template: templates/clusterrole-operator.yaml
    asserts:
      - isKind:
          of: ClusterRole
      - contains:
          path: rules
          content:
            apiGroups: ["pages.kup6s.com"]
            resources: ["staticsites"]
            verbs: ["get", "list", "watch", "update", "patch"]

  - it: should create syncer clusterrole with correct API group
    template: templates/clusterrole-syncer.yaml
    asserts:
      - isKind:
          of: ClusterRole
      - contains:
          path: rules
          content:
            apiGroups: ["pages.kup6s.com"]
            resources: ["staticsites"]
            verbs: ["get", "list", "watch"]

  - it: should not create RBAC when disabled
    template: templates/clusterrole-operator.yaml
    set:
      rbac.create: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should not create serviceaccount when disabled
    template: templates/serviceaccount-operator.yaml
    set:
      operator.serviceAccount.create: false
    asserts:
      - hasDocuments:
          count: 0

  # Namespace-scoped Role tests
  - it: should create operator role for namespace-scoped resources
    template: templates/role-operator.yaml
    asserts:
      - isKind:
          of: Role
      - matchRegex:
          path: metadata.name
          pattern: -operator$

  - it: should grant traefik ingressroute permissions in role
    template: templates/role-operator.yaml
    asserts:
      - contains:
          path: rules
          content:
            apiGroups: ["traefik.io"]
            resources: ["ingressroutes", "middlewares"]
            verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

  - it: should grant cert-manager certificate permissions in role
    template: templates/role-operator.yaml
    asserts:
      - contains:
          path: rules
          content:
            apiGroups: ["cert-manager.io"]
            resources: ["certificates"]
            verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

  - it: should grant coordination lease permissions in role
    template: templates/role-operator.yaml
    asserts:
      - contains:
          path: rules
          content:
            apiGroups: ["coordination.k8s.io"]
            resources: ["leases"]
            verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

  - it: should not create role when rbac disabled
    template: templates/role-operator.yaml
    set:
      rbac.create: false
    asserts:
      - hasDocuments:
          count: 0

  # Namespace-scoped RoleBinding tests
  - it: should create operator rolebinding
    template: templates/rolebinding-operator.yaml
    asserts:
      - isKind:
          of: RoleBinding
      - matchRegex:
          path: metadata.name
          pattern: -operator$

  - it: should reference correct role in rolebinding
    template: templates/rolebinding-operator.yaml
    asserts:
      - equal:
          path: roleRef.kind
          value: Role
      - matchRegex:
          path: roleRef.name
          pattern: -operator$

  - it: should reference correct serviceaccount in rolebinding
    template: templates/rolebinding-operator.yaml
    asserts:
      - equal:
          path: subjects[0].kind
          value: ServiceAccount
      - matchRegex:
          path: subjects[0].name
          pattern: -operator$

  - it: should not create rolebinding when rbac disabled
    template: templates/rolebinding-operator.yaml
    set:
      rbac.create: false
    asserts:
      - hasDocuments:
          count: 0
