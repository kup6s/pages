name: Deploy Docs

# Manual trigger only. Docs are automatically built after releases in release.yaml.
# Use this workflow for testing docs changes or rebuilding without a release.
on:
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'
          extended: true

      - name: Generate build info
        run: |
          VERSION=$(grep '^version:' charts/kup6s-pages/Chart.yaml | awk '{print $2}')
          BUILD_DATE=$(date -u +'%Y-%m-%d')
          mkdir -p docs/data
          cat > docs/data/build.yaml << EOF
          version: "${VERSION}"
          date: "${BUILD_DATE}"
          EOF

      - name: Build docs
        run: hugo --source docs --minify

      - name: Deploy to docs branch
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: docs
          publish_dir: ./docs/public
          force_orphan: true
